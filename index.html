<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Click Hero Lite</title>
<style>
  :root{
    --bg:#0f172a; /* slate-900 */
    --panel:#111827; /* gray-900 */
    --soft:#1f2937; /* gray-800 */
    --text:#e5e7eb; /* gray-200 */
    --muted:#9ca3af; /* gray-400 */
    --accent:#22d3ee; /* cyan-400 */
    --good:#34d399; /* emerald-400 */
    --warn:#fbbf24; /* amber-400 */
    --danger:#f87171; /* red-400 */
  }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1223,#0f172a 40%,#0b1223);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Hiragino Sans","Noto Sans JP","Noto Sans",sans-serif}
  .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
  header{display:grid;grid-template-columns:1fr auto auto;gap:12px;align-items:center;margin-bottom:12px}
  .stat{background:var(--panel);padding:10px 12px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,0.25);display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .pill{padding:6px 10px;border-radius:999px;background:var(--soft);font-weight:700}
  .btn{cursor:pointer;border:0;padding:10px 14px;border-radius:12px;background:var(--soft);color:var(--text);font-weight:700;transition:transform .04s ease,filter .2s;}
  .btn:hover{filter:brightness(1.15)}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:linear-gradient(135deg,#06b6d4,#22d3ee)}
  .btn.good{background:linear-gradient(135deg,#10b981,#34d399)}
  .btn.warn{background:linear-gradient(135deg,#f59e0b,#fbbf24);color:#111}
  .btn.danger{background:linear-gradient(135deg,#ef4444,#f87171)}
  .grid{display:grid;grid-template-columns:1.1fr .6fr .6fr;gap:16px}
  .card{background:var(--panel);border:1px solid #1f2937;padding:16px;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.3)}
  h1{font-size:20px;margin:0 0 10px 0}
  h2{font-size:16px;margin:0 0 10px 0;color:var(--muted)}
  .monster-area{display:grid;place-items:center;min-height:360px;background:radial-gradient(1200px 400px at 50% 0%,rgba(34,211,238,0.08),transparent);border:1px solid #1e293b;border-radius:16px}
  .monster{width:220px;height:220px;border-radius:24px;background:linear-gradient(145deg,#172554,#1f2937);display:grid;place-items:center;position:relative;cursor:pointer;user-select:none}
  .monster:hover{box-shadow:0 0 0 2px rgba(34,211,238,.2) inset,0 12px 30px rgba(0,0,0,.35)}
  .monster:active{transform:scale(.99)}
  .monster .eyes{display:flex;gap:22px}
  .eye{width:26px;height:26px;border-radius:50%;background:#e5e7eb;position:relative}
  .eye::after{content:"";position:absolute;width:12px;height:12px;border-radius:50%;background:#111;left:7px;top:7px}
  .fang{position:absolute;bottom:44px;left:50%;transform:translateX(-50%);display:flex;gap:12px}
  .fang span{width:10px;height:16px;background:#e5e7eb;clip-path:polygon(0 0,100% 0,50% 100%)}
  .monster .name{position:absolute;top:10px;left:0;right:0;text-align:center;font-weight:800;color:#a5b4fc}
  .hpbar{width:90%;height:16px;background:#0b1223;border:1px solid #1e293b;border-radius:999px;overflow:hidden;position:absolute;bottom:10px;left:5%}
  .hpfill{height:100%;background:linear-gradient(90deg,#10b981,#22d3ee);width:100%}
  .hptext{position:absolute;bottom:10px;left:0;right:0;text-align:center;font-size:12px;color:#cbd5e1}
  .floating{position:absolute;pointer-events:none;font-weight:900;color:#fff;text-shadow:0 2px 6px rgba(0,0,0,.35)}
  .shop-list,.upgrade-list,.inv-list{display:grid;gap:10px;max-height:480px;overflow:auto;padding-right:6px}
  .row{display:flex;gap:10px;align-items:center;justify-content:space-between;background:var(--soft);border:1px solid #293548;border-radius:12px;padding:10px 12px}
  .row .meta{display:flex;flex-direction:column}
  .cost{color:var(--muted)}
  .small{font-size:12px;color:var(--muted)}
  .kbd{background:#0b1223;border:1px solid #1e293b;border-radius:8px;padding:2px 6px;font-size:12px}
  footer{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap}
  .hr{height:1px;background:#243042;margin:12px 0}
  .boss{color:#fca5a5;font-weight:800}
  .tiny{font-size:11px;color:#94a3b8}
  .timer{padding:4px 8px;border-radius:10px;background:#1b2536;border:1px solid #2a3b54}

/* --- æ–°ã—ã„ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ãƒ‡ã‚¶ã‚¤ãƒ³ --- */
/* ã‚³ã‚¦ãƒ¢ãƒª (bat) - æš—ã„ã€èµ¤ã„ç›®ã€é‹­ã„ç‰™ */
.monster.bat{
  background: linear-gradient(145deg, #181824, #121218); /* é»’ã£ã½ã„ */
}
.monster.bat .eye{
  background: #f87171; /* èµ¤ã„ç›® */
}
.monster.bat .eye::after{
  background: #000;
  width: 8px; /* ç³ã‚’å°ã•ã */
  height: 8px;
  left: 9px;
  top: 9px;
}
.monster.bat .fang span{
  height: 20px; /* ç‰™ã‚’é•·ã */
}
/* ã‚¹ã‚±ãƒ«ãƒˆãƒ³ (skeleton) - ç™½ã„ã€ç©ºæ´ã®ç›® */
.monster.skeleton{
  background: linear-gradient(145deg, #9ca3af, #52525b); /* éª¨ã®è‰² */
}
.monster.skeleton .eye{
  background: #000; /* ç›®ã‚’ç©ºæ´ã« */
  border: 4px solid #fff;
}
.monster.skeleton .eye::after{
  display: none; /* ç³ã‚’æ¶ˆã™ */
}
.monster.skeleton .fang span{
  background: #e5e7eb; /* ç‰™ã‚’ç™½ã */
}
/* ã‚ªãƒ¼ã‚¯ (orc) - ç·‘ã€å¤ªã„ç‰™ */
.monster.orc{
  background: linear-gradient(145deg, #4d7c0f, #365314); /* ã‚ªãƒ¼ã‚¯ã‚°ãƒªãƒ¼ãƒ³ */
}
.monster.orc .eye{
  background: #fbbf24; /* é»„è‰²ã„ç›® */
}
.monster.orc .eye::after{
  background: #000;
  width: 10px;
  height: 10px;
  left: 8px;
  top: 8px;
}
.monster.orc .fang{
  bottom: 30px; /* ç‰™ã®ä½ç½®ã‚’å°‘ã—ä¸Šã’ã‚‹ */
}
.monster.orc .fang span{
  width: 14px; /* ç‰™ã‚’å¤ªã */
  height: 20px; /* ç‰™ã‚’é•·ã */
}
/* ã‚¦ãƒ«ãƒ• (wolf) - ç°è‰²ã€é‹­ã„ç›® */
.monster.wolf{
  background: linear-gradient(145deg, #374151, #1f2937); /* ã‚°ãƒ¬ãƒ¼ */
}
.monster.wolf .eye{
  background: #fcd34d; /* ç¥ç€è‰² */
}
.monster.wolf .eye::after{
  background: #111;
  width: 8px;
  height: 14px; /* ç³ã‚’ç¸¦é•·ã« */
  top: 6px;
  left: 9px;
}
/* ã‚´ãƒ–ãƒªãƒ³ (goblin) - é»„ç·‘ã€ãšã‚‹è³¢ã„ç›® */
.monster.goblin{
  background: linear-gradient(145deg, #65a30d, #4d7c0f); /* é®®ã‚„ã‹ãªç·‘ */
}
.monster.goblin .eye{
  width: 20px;
  height: 20px;
  background: #fff;
}
.monster.goblin .eye::after{
  background: #4d7c0f; /* ç³ã®è‰²ã‚‚ç·‘ã« */
  width: 8px;
  height: 8px;
  left: 6px;
  top: 6px;
}
.monster.goblin .fang span{
  height: 12px; /* ç‰™ã‚’å°ã•ã */
}
/* ã‚·ãƒ£ãƒ‰ã‚¦ (shadow) - å½±ã€å…‰ã‚‹ç›® */
.monster.shadow{
  background: linear-gradient(145deg, #0f172a, #0c101a); /* è¶…æš—ã„è‰² */
  border: 1px solid rgba(34,211,238,0.2); /* ã‚ãšã‹ã«å…‰ã‚‹å¢ƒç•Œ */
}
.monster.shadow .eyes{
  gap: 30px;
}
.monster.shadow .eye{
  background: #22d3ee; /* ã‚·ã‚¢ãƒ³ã«å…‰ã‚‹ç›® */
}
.monster.shadow .eye::after{
  display: none; /* ç³ã‚’æ¶ˆã™ */
}
.monster.shadow .fang{
  opacity: 0.5; /* ç‰™ã‚’åŠé€æ˜ã« */
}
/* ãƒ¯ã‚¤ãƒãƒ¼ãƒ³ (wyvern) - é’ã€æ´¾æ‰‹ãªè‰² */
.monster.wyvern{
  background: linear-gradient(145deg, #0ea5e9, #0369a1); /* é®®ã‚„ã‹ãªé’ */
}
.monster.wyvern .eye{
  background: #fcd34d; /* é‡‘è‰²ã®ç›® */
}
.monster.wyvern .eye::after{
  background: #111;
  width: 6px;
  height: 6px;
  left: 10px;
  top: 10px;
}
.monster.wyvern .fang span{
  background: #fff;
  width: 8px; /* ç‰™ã‚’ç´°ã */
}
/* ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹ (minotaur) - èŒ¶è‰²ã€ä½“ãŒå¤§ãã„ */
.monster.minotaur{
  width: 260px; /* ä½“ã‚’å¤§ãã */
  height: 260px;
  background: linear-gradient(145deg, #7c2d12, #431407); /* èŒ¶è‰² */
}
.monster-area{
  min-height: 400px; /* ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ã®æœ€å°é«˜ã•ã‚’èª¿æ•´ */
}
.monster.minotaur .eyes{
  gap: 16px;
}
.monster.minotaur .eye{
  width: 30px;
  height: 30px;
  background: #facc15;
}
.monster.minotaur .eye::after{
  width: 14px;
  height: 14px;
  left: 8px;
  top: 8px;
}
/* ãƒ‰ãƒ©ã‚³ (draco) - èµ¤ã€ç¸¦é•·ã®ã‚¹ãƒªãƒƒãƒˆã®ç›® */
.monster.draco{
  background: linear-gradient(145deg, #dc2626, #991b1b); /* ãƒ‰ãƒ©ã‚´ãƒ³ãƒ¬ãƒƒãƒ‰ */
}
.monster.draco .eye{
  background: #fcd34d; /* é‡‘è‰²ã®ç›® */
  overflow: hidden;
}
.monster.draco .eye::after{
  background: #111;
  width: 4px; /* ç³ã‚’éå¸¸ã«ç´°ã */
  height: 20px;
  left: 11px;
  top: 3px;
  border-radius: 0; /* å››è§’å½¢ã«ã™ã‚‹ */
}
  
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="stat" id="topStats">
      <div><span class="pill">ãƒ•ãƒ­ã‚¢ <span id="floor">1</span><span id="bossFlag" class="pill" style="margin-left:8px;display:none;background:#3b1f2b;color:#fda4af">BOSS</span></span></div>
      <div>ğŸ’° ã‚³ã‚¤ãƒ³: <b id="coins">0</b></div>
      <div>ğŸ’ ã‚¸ã‚§ãƒ : <b id="gems">0</b></div>
      <div>ğŸ—¡ ã‚¯ãƒªãƒƒã‚¯: <b id="clickDmg">1</b>/hit</div>
      <div>âš” DPS: <b id="dps">0</b>/s</div>
      <div id="bossTimerWrap" style="display:none">â± æ®‹ã‚Š: <span id="bossTimer" class="timer">--</span></div>
    </div>
    <button class="btn" id="saveBtn">ä¿å­˜</button>
    <button class="btn danger" id="wipeBtn" title="ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤">ãƒªã‚»ãƒƒãƒˆ</button>
  </header>

  <div class="grid">
    <div class="card monster-area">
      <div>
        <h1 id="monsterTitle">ã‚¹ãƒ©ã‚¤ãƒ  (Lv.1)</h1>
        <div class="small">å€’ã™ã¨ <span id="goldReward">1</span> ã‚³ã‚¤ãƒ³ç²å¾—</div>
      </div>
      <div class="monster" id="monster">
        <div class="name" id="monsterName">ã‚¹ãƒ©ã‚¤ãƒ </div>
        <div class="eyes"><div class="eye"></div><div class="eye"></div></div>
        <div class="fang"><span></span><span></span></div>
        <div class="hpbar"><div class="hpfill" id="hpFill"></div></div>
        <div class="hptext" id="hpText">HP 10 / 10</div>
      </div>
      <footer>
        <button class="btn primary" id="attackBtn">ã‚¯ãƒªãƒƒã‚¯æ”»æ’ƒ (ã‚¹ãƒšãƒ¼ã‚¹)</button>
        <button class="btn danger" id="surrenderBtn" style="display:none" title="ãƒœã‚¹æˆ¦ã‹ã‚‰æ’¤é€€ã—5ãƒ•ãƒ­ã‚¢æˆ»ã‚‹">ğŸ³ é™å‚</button>
        <button class="btn warn" id="rebirthBtn" disabled>è»¢ç”Ÿ (ã‚¸ã‚§ãƒ ç²å¾—)</button>
        <span class="tiny" id="rebirthInfo">è»¢ç”Ÿã¯ãƒ•ãƒ­ã‚¢50ä»¥ä¸Šã§è§£æ”¾</span>
      </footer>
    </div>

    <div class="card">
      <h1>å‚­å…µï¼ˆDPSï¼‰</h1>
      <div class="shop-list" id="mercList"></div>
      <div class="hr"></div>
      <h1>ã‚³ã‚¤ãƒ³å¼·åŒ–</h1>
      <div class="upgrade-list" id="coinUpList"></div>
      <div class="hr"></div>
      <h1>ã‚¸ã‚§ãƒ æ’ä¹…å¼·åŒ–</h1>
      <div class="upgrade-list" id="gemUpList"></div>
    </div>

    <div class="card">
      <h1>ã‚¢ã‚¤ãƒ†ãƒ å›³é‘‘ï¼ˆæ’ä¹…åŠ¹æœï¼‰</h1>
      <div class="small">ãƒœã‚¹ä»¥å¤–ã®æ•µã‹ã‚‰ä½ç¢ºç‡ã§ãƒ‰ãƒ­ãƒƒãƒ—ã€‚é‡è¤‡ã§åŠ¹æœåŠ ç®—ï¼ˆæ°¸ç¶šï¼‰ã€‚</div>
      <div class="inv-list" id="invList"></div>
    </div>
  </div>
  <footer id="globalFooter">
    <div id="speedControls">
      ã‚²ãƒ¼ãƒ é€Ÿåº¦:
      <button class="btn primary" data-speed="1" id="speed1">1x</button>
      <button class="btn" data-speed="2" id="speed2">2x</button>
      <button class="btn" data-speed="5" id="speed5">5x</button>
      <button class="btn" data-speed="10" id="speed10">10x</button>
    </div>
  </footer>
</div>

<script>
(function(){
  // ======= Utility =======
  const fmtI = n=> Math.floor(n).toLocaleString();
  const fmt = n=>{
    if(n<1000) return Math.floor(n).toString();
    const units = ["","K","M","B","T","Qa","Qi","Sx","Sp","Oc","No"]; // enough for demo
    let idx=0; let val=n;
    while(val>=1000 && idx<units.length-1){val/=1000; idx++;}
    return (Math.floor(val*10)/10).toLocaleString()+units[idx];
  }
  const clamp=(x,a,b)=>Math.max(a,Math.min(b,x));
  const rand=()=>Math.random();
  const choice=arr=>arr[Math.floor(Math.random()*arr.length)];

  // ======= Game Data =======
  const BASE_HP = 10;
  const HP_GROWTH = 1.18; // per floor
  const BOSS_HP_MULT = 5; // ãƒœã‚¹HP(å€ç‡)
  const BOSS_TIMER_SEC = 20; // ãƒœã‚¹åˆ¶é™æ™‚é–“ï¼ˆç§’ï¼‰
  const BOSS_REWARD_GEMS = f=> 1 + Math.floor(f/25); // simple formula
  const GOLD_REWARD = f=> 1 + Math.floor(Math.pow(f,1.25));
  const REBIRTH_MIN_FLOOR = 50;
  const ITEM_DROP_RATE = 0.03; // ã‚¢ã‚¤ãƒ†ãƒ ã®ãƒ‰ãƒ­ãƒƒãƒ—ç‡ 3%

  // ã‚³ã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ»ã‚¸ã‚§ãƒ ã‚¢ãƒƒãƒ—
  const COIN_UPS = [
    { key:"clickLvl", name:"æ­¦å™¨å¼·åŒ–", desc:"ã‚¯ãƒªãƒƒã‚¯ãƒ€ãƒ¡ãƒ¼ã‚¸+1", baseCost: 25, growth:1.15 },
    { key:"goldBoostLvl", name:"é‡‘ç­–", desc:"ã‚³ã‚¤ãƒ³ç²å¾—+10%", baseCost: 100, growth:1.17 },
  ];
  const GEM_UPS = [
    { key:"clickGem", name:"è¦‡æ°—", desc:"ã‚¯ãƒªãƒƒã‚¯ãƒ€ãƒ¡ãƒ¼ã‚¸ +25%/Lv (æ’ä¹…)", baseCost: 5, growth: 1.8, type:"multClick", per:0.25 },
    { key:"dpsGem", name:"æˆ¦è¡“", desc:"DPS +20%/Lv (æ’ä¹…)", baseCost: 5, growth: 1.8, type:"multDps", per:0.20 },
    { key:"goldGem", name:"å¼·æ¬²", desc:"ã‚³ã‚¤ãƒ³ +15%/Lv (æ’ä¹…)", baseCost: 5, growth: 1.8, type:"multGold", per:0.15 },
  ];

  // å‚­å…µï¼ˆ10Lvã”ã¨ã«+10%ã®å¤§å¼·åŒ–ï¼šç·DPSå€ç‡ 1.1^(floor(Lv/10)) ï¼‰
  const MERCS = [
    { key:"slasher", name:"ã‚¹ãƒ©ãƒƒã‚·ãƒ£ãƒ¼", baseDps:1, baseCost: 10, growth:1.12 },
    { key:"archer", name:"ã‚¢ãƒ¼ãƒãƒ£ãƒ¼", baseDps:8, baseCost: 80, growth:1.12 },
    { key:"mage", name:"ãƒ¡ã‚¤ã‚¸", baseDps:50, baseCost: 500, growth:1.13 },
    { key:"ninja", name:"ãƒ‹ãƒ³ã‚¸ãƒ£", baseDps:300, baseCost: 3000, growth:1.14 },
    { key:"golem", name:"ã‚´ãƒ¼ãƒ¬ãƒ ", baseDps:2000, baseCost: 20000, growth:1.15 },
  ];

  // ãƒ‰ãƒ­ãƒƒãƒ—ã‚¢ã‚¤ãƒ†ãƒ ï¼ˆæ’ä¹…ï¼‰
  const ITEMS = [
    { key:"fang", name:"ã‚·ãƒ£ãƒ¼ãƒ—ãƒ•ã‚¡ãƒ³ã‚°", desc:"ã‚¯ãƒªãƒƒã‚¯ãƒ€ãƒ¡ãƒ¼ã‚¸ +5%", type:"click", per:0.05 },
    { key:"charm", name:"ãƒ©ãƒƒã‚­ãƒ¼ãƒ¡ãƒ€ãƒ«ğŸ–ï¸", desc:"ã‚³ã‚¤ãƒ³ç²å¾— +5%", type:"gold", per:0.05 },
    { key:"cog", name:"ã‚¨ãƒ³ã‚·ã‚§ãƒ³ãƒˆã‚³ã‚°", desc:"DPS +5%", type:"dps", per:0.05 },
  ];

  const monsters = ["ã‚¹ãƒ©ã‚¤ãƒ ","ã‚³ã‚¦ãƒ¢ãƒª","ã‚¹ã‚±ãƒ«ãƒˆãƒ³","ã‚ªãƒ¼ã‚¯","ã‚¦ãƒ«ãƒ•","ã‚´ãƒ–ãƒªãƒ³","ã‚·ãƒ£ãƒ‰ã‚¦","ãƒ¯ã‚¤ãƒãƒ¼ãƒ³","ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹","ãƒ‰ãƒ©ã‚³" ];

  // ======= State =======
  const S = {
    coins: 0,
    gems: 0,
    floor: 1,
    monsterHP: BASE_HP,
    monsterMax: BASE_HP,
    isBoss: false,
    bossTimeLeft: 0,
    mercs: {}, // key -> level
    coinUps: {}, // key -> level
    gemUps: {}, // key -> level (persistent across rebirth)
    items: {}, // key -> count (æ°¸ä¹…)
    unspentBossGems: 0,
    bestFloor: 1,
    speedMult: 1, // NEW: ã‚²ãƒ¼ãƒ é€Ÿåº¦å€ç‡
  };

  // init collections
  MERCS.forEach(m=> S.mercs[m.key]=0);
  COIN_UPS.forEach(u=> S.coinUps[u.key]=0);
  GEM_UPS.forEach(u=> S.gemUps[u.key]=0);
  ITEMS.forEach(it=> S.items[it.key]=S.items[it.key]||0);

  // ======= Persistence =======
  const save=()=>{ localStorage.setItem("clickHeroLite.save", JSON.stringify(S)); }
  const load=()=>{
    const raw = localStorage.getItem("clickHeroLite.save");
    if(!raw) return;
    try{
      const d = JSON.parse(raw);
      Object.assign(S,d);
      MERCS.forEach(m=> S.mercs[m.key] ??= 0);
      COIN_UPS.forEach(u=> S.coinUps[u.key] ??= 0);
      GEM_UPS.forEach(u=> S.gemUps[u.key] ??= 0);
      ITEMS.forEach(it=> S.items[it.key] ??= 0);
      S.speedMult ??= 1; // NEW: é€Ÿåº¦å€ç‡ã‚’åˆæœŸåŒ–
    }catch(e){console.warn("Load failed",e)}
  }

  // ======= Calculations =======
  function floorIsBoss(f){ return f % 10 === 0; }
  function floorMonsterHP(f){
    const hp = BASE_HP * Math.pow(HP_GROWTH, f-1);
    return Math.floor(hp * (floorIsBoss(f) ? BOSS_HP_MULT : 1));
  }
  function mercDpsOf(m){
    const lvl = S.mercs[m.key]||0;
    if(lvl<=0) return 0;
    const bigBoosts = Math.floor(lvl/10);
    const mult = Math.pow(1.1, bigBoosts); // 10Lvã”ã¨+10%
    return m.baseDps * lvl * mult;
  }
  function totalDps(){
    let dps=0;
    for(const m of MERCS){ dps += mercDpsOf(m); }
    // item & gem multipliers
    const itemMul = 1 + (S.items.cog||0) * getItem('cog').per;
    const gemMul = 1 + (S.gemUps["dpsGem"]||0) * getGemUp("dpsGem").per;
    return Math.floor(dps * itemMul * gemMul);
  }
  function clickDamage(){
    const base = 1 + (S.coinUps["clickLvl"]||0);
    const gemMul = 1 + (S.gemUps["clickGem"]||0) * getGemUp("clickGem").per;
    const itemMul = 1 + (S.items.fang||0) * getItem('fang').per;
    return Math.max(1, Math.floor(base * gemMul * itemMul));
  }
  function goldGain(base){
    const coinMul = 1 + (S.coinUps["goldBoostLvl"]||0) * 0.10;
    const gemMul = 1 + (S.gemUps["goldGem"]||0) * getGemUp("goldGem").per;
    const itemMul = 1 + (S.items.charm||0) * getItem('charm').per;
    return Math.floor(base * coinMul * gemMul * itemMul);
  }
  function costFor(base,growth,level){ return Math.floor(base * Math.pow(growth, level)); }
  function getGemUp(k){ return GEM_UPS.find(x=>x.key===k); }
  function getItem(k){ return ITEMS.find(x=>x.key===k); }

  // ======= Monster =======
  function spawnMonster(){
    S.isBoss = floorIsBoss(S.floor);
    S.monsterMax = floorMonsterHP(S.floor);
    S.monsterHP = S.monsterMax;
    if(S.isBoss){ S.bossTimeLeft = BOSS_TIMER_SEC; } else { S.bossTimeLeft = 0; }
    
    // ç¾åœ¨ã®ãƒ•ãƒ­ã‚¢ã«å¯¾å¿œã™ã‚‹ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼åã‚’å–å¾—
    const monsterKey = monsters[(S.floor-1) % monsters.length];
    
    // ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼åã¨CSSã‚¯ãƒ©ã‚¹åã®å¯¾å¿œè¡¨
    const monsterClassMap = {
      "ã‚¹ãƒ©ã‚¤ãƒ ": "",
      "ã‚³ã‚¦ãƒ¢ãƒª": "bat",
      "ã‚¹ã‚±ãƒ«ãƒˆãƒ³": "skeleton",
      "ã‚ªãƒ¼ã‚¯": "orc",
      "ã‚¦ãƒ«ãƒ•": "wolf",
      "ã‚´ãƒ–ãƒªãƒ³": "goblin",
      "ã‚·ãƒ£ãƒ‰ã‚¦": "shadow",
      "ãƒ¯ã‚¤ãƒãƒ¼ãƒ³": "wyvern",
      "ãƒŸãƒã‚¿ã‚¦ãƒ­ã‚¹": "minotaur",
      "ãƒ‰ãƒ©ã‚³": "draco",
    };
    
    // å¯¾å¿œã™ã‚‹CSSã‚¯ãƒ©ã‚¹åã‚’å–å¾—ã—ã¦é©ç”¨
    const designClass = monsterClassMap[monsterKey] || '';
    monsterEl.className = 'monster ' + designClass; 

    uiMonster();
  }

  // ======= Combat & Drops =======
  function onKill(){
    const reward = goldGain(GOLD_REWARD(S.floor));
    S.coins += reward;
    if(S.isBoss){
      const g = BOSS_REWARD_GEMS(S.floor);
      S.gems += g; S.unspentBossGems += g;
      flash(`BOSS æ’ƒç ´ï¼ +${g}ğŸ’, +${fmt(reward)}ğŸ’°`);
    } else {
      // ä½ç¢ºç‡ãƒ‰ãƒ­ãƒƒãƒ—
      if(rand() < ITEM_DROP_RATE){
        const it = choice(ITEMS);
        S.items[it.key] = (S.items[it.key]||0) + 1;
        flash(`ğŸ“¦ ã‚¢ã‚¤ãƒ†ãƒ å…¥æ‰‹: ${it.name}ï¼ˆ${it.desc}ï¼‰`);
      } else {
        flash(`+${fmt(reward)} ğŸ’°`);
      }
    }
    S.bestFloor = Math.max(S.bestFloor, S.floor+1);
    nextFloor();
    uiTop();
  }

  function hit(amount){
    popFloat(`-${fmt(amount)}`);
    S.monsterHP = clamp(S.monsterHP - amount, 0, S.monsterMax);
    if(S.monsterHP<=0){ onKill(); }
    uiAll();
  }

  function nextFloor(){
    S.floor++;
    spawnMonster();
  }

  // ======= Boss Timeout / Surrender =======
  function onBossTimeout(){
    // ãƒœã‚¹æ’ƒç ´ã«å¤±æ•—ï¼š9ã¤å‰ã®é€šå¸¸éšã«æˆ»ã™
    const prev = Math.max(1, S.floor-9);
    S.floor = prev;
    flash('ãƒœã‚¹æ’ƒç ´å¤±æ•—â€¦ 9ãƒ•ãƒ­ã‚¢æˆ»ã‚Šã¾ã—ãŸ');
    spawnMonster();
  }
  
  // NEW: é™å‚å‡¦ç†
  function doSurrender(){
    if(!S.isBoss) return;
    onBossTimeout(); // æ—¢å­˜ã®ãƒ•ãƒ­ã‚¢ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’æµç”¨
    uiAll();
    save();
  }

  // ======= Rebirth =======
  function canRebirth(){ return S.floor >= REBIRTH_MIN_FLOOR; }
  function previewRebirthGems(){
    if(!canRebirth()) return 0;
    return Math.floor((S.floor - REBIRTH_MIN_FLOOR + 10) / 10);
  }
  function doRebirth(){
    if(!canRebirth()) return;
    const gain = previewRebirthGems();
    S.gems += gain;
    S.unspentBossGems += gain;

    // Runãƒªã‚»ãƒƒãƒˆï¼ˆæ’ä¹…ï¼šgemUps ã¨ items ã¯ç¶­æŒï¼‰
    S.coins = 0;
    MERCS.forEach(m=> S.mercs[m.key]=0);
    COIN_UPS.forEach(u=> S.coinUps[u.key]=0);
    S.floor = 1;
    spawnMonster();
    flash(`è»¢ç”Ÿå®Œäº†ï¼ +${gain}ğŸ’ã€‚æ’ä¹…å¼·åŒ–ï¼†ã‚¢ã‚¤ãƒ†ãƒ ã§å†å‡ºç™ºï¼`);
    uiAll();
    save();
  }

  // ======= UI =======
  const el = s=> document.querySelector(s);
  const topCoins = el('#coins');
  const topGems = el('#gems');
  const topClick = el('#clickDmg');
  const topDps = el('#dps');
  const floorEl = el('#floor');
  const bossFlag = el('#bossFlag');
  const bossTimerWrap = el('#bossTimerWrap');
  const bossTimer = el('#bossTimer');
  const monsterEl = el('#monster');
  const hpFill = el('#hpFill');
  const hpText = el('#hpText');
  const monsterTitle = el('#monsterTitle');
  const monsterName = el('#monsterName');
  const goldReward = el('#goldReward');
  const rebirthBtn = el('#rebirthBtn');
  const rebirthInfo = el('#rebirthInfo');
  const mercList = el('#mercList');
  const coinUpList = el('#coinUpList');
  const gemUpList = el('#gemUpList');
  const invList = el('#invList');
  const surrenderBtn = el('#surrenderBtn'); // NEW
  const speedControls = el('#speedControls'); // NEW

  function uiMonster(){
    const name = monsters[(S.floor-1) % monsters.length];
    monsterTitle.textContent = `${S.isBoss? 'â˜…ãƒœã‚¹â˜… ' : ''}${name} (Lv.${S.floor})`;
    monsterName.textContent = name + (S.isBoss? 'ãƒ»ãƒœã‚¹':'' );
    goldReward.textContent = fmt(GOLD_REWARD(S.floor));
    bossFlag.style.display = S.isBoss? 'inline-block':'none';
    bossTimerWrap.style.display = S.isBoss? 'inline-flex':'none';
    surrenderBtn.style.display = S.isBoss? 'inline-block':'none'; // NEW: é™å‚ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ‡æ›¿
    updateHpBar();
    updateBossTimer();
  }
  function updateHpBar(){
    const pct = (S.monsterHP / S.monsterMax) * 100;
    hpFill.style.width = `${pct}%`;
    hpText.textContent = `HP ${fmt(S.monsterHP)} / ${fmt(S.monsterMax)}`;
  }
  function updateBossTimer(){
    if(!S.isBoss){ bossTimer.textContent='--'; return; }
    bossTimer.textContent = `${Math.ceil(S.bossTimeLeft)}s`;
  }
  function uiTop(){
    topCoins.textContent = fmt(S.coins);
    topGems.textContent = fmt(S.gems);
    topClick.textContent = fmt(clickDamage());
    topDps.textContent = fmt(totalDps());
    floorEl.textContent = fmtI(S.floor);

    const can = canRebirth();
    rebirthBtn.disabled = !can;
    rebirthBtn.title = can? `è»¢ç”Ÿã§ +${previewRebirthGems()}ğŸ’ (å‚­å…µ/ã‚³ã‚¤ãƒ³å¼·åŒ–ã¯åˆæœŸåŒ–, æ’ä¹…å¼·åŒ–/ã‚¢ã‚¤ãƒ†ãƒ ã¯ç¶­æŒ)` : `ãƒ•ãƒ­ã‚¢${REBIRTH_MIN_FLOOR} ã§è§£æ”¾`;
    rebirthInfo.textContent = can? `ä»Šè»¢ç”Ÿã™ã‚‹ã¨ +${previewRebirthGems()}ğŸ’` : `è»¢ç”Ÿã¯ãƒ•ãƒ­ã‚¢${REBIRTH_MIN_FLOOR}ä»¥ä¸Šã§è§£æ”¾`;
  }
  function uiMercs(){
    mercList.innerHTML = '';
    for(const m of MERCS){
      const lvl = S.mercs[m.key]||0;
      const each = m.baseDps;
      // [ãƒœã‚¿ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®ä¿®æ­£]
      let buttonText;
      if (lvl === 0) {
        buttonText = "é›‡ç”¨"; // Lv.0
      } else if (lvl > 0 && lvl % 10 === 9) {
        buttonText = "å¤§å¼·åŒ–"; // Lv.9, 19, 29...ã®æ™‚
      } else {
        buttonText = "å¼·åŒ–"; // ä¸Šè¨˜ä»¥å¤–
      }
      const cost = costFor(m.baseCost, m.growth, lvl);
      const canBuy = S.coins >= cost;
      // DPSè¨ˆç®—ã¨ãƒ¬ãƒ™ãƒ«æ¨ªã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
      const boosts = Math.floor(lvl/10);
      const mult = Math.pow(1.1, boosts);
      const total = each*lvl*mult;
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <div class="meta">
          <div><b>${m.name}</b> <span class="small">Lv.${lvl}</span></div>
          <div class="small">+${fmt(each)} DPS/Lv (x${mult.toFixed(2)}) <br>åˆè¨ˆ: <b>${fmt(total)}</b> DPS</div>
          <div class="cost">ã‚³ã‚¹ãƒˆ: ${fmt(cost)}ğŸ’°</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn ${canBuy?'good':''}" ${canBuy?'':'disabled'} data-key="${m.key}">${buttonText}</button>
        </div>`;
      row.querySelector('button').onclick = ()=>{
        if(S.coins < cost) return;
        S.coins -= cost;
        S.mercs[m.key] = (S.mercs[m.key]||0) + 1;
        uiAll();
      };
      mercList.appendChild(row);
    }
  }
  function uiCoinUps(){
    coinUpList.innerHTML = '';
    for(const u of COIN_UPS){
      const lvl = S.coinUps[u.key]||0;
      const cost = costFor(u.baseCost, u.growth, lvl);
      const can = S.coins >= cost;
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <div class="meta">
          <div><b>${u.name}</b> <span class="small">Lv.${lvl}</span></div>
          <div class="small">${u.desc}</div>
          <div class="cost">ã‚³ã‚¹ãƒˆ: ${fmt(cost)}ğŸ’°</div>
        </div>
        <button class="btn ${can?'primary':''}" ${can?'':'disabled'}>è³¼å…¥</button>`;
      row.querySelector('button').onclick = ()=>{
        if(S.coins < cost) return;
        S.coins -= cost;
        S.coinUps[u.key] = lvl + 1;
        uiAll();
      };
      coinUpList.appendChild(row);
    }
  }
  function uiGemUps(){
    gemUpList.innerHTML = '';
    for(const u of GEM_UPS){
      const lvl = S.gemUps[u.key]||0;
      const cost = costFor(u.baseCost, u.growth, lvl);
      const can = S.gems >= cost;
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <div class="meta">
          <div><b>${u.name}</b> <span class="small">Lv.${lvl}</span> <span class="tiny">(${u.desc})</span></div>
          <div class="cost">ã‚³ã‚¹ãƒˆ: ${fmt(cost)}ğŸ’</div>
        </div>
        <button class="btn ${can?'warn':''}" ${can?'':'disabled'}>å¼·åŒ–</button>`;
      row.querySelector('button').onclick = ()=>{
        if(S.gems < cost) return;
        S.gems -= cost;
        S.gemUps[u.key] = lvl + 1;
        uiAll();
        save();
      };
      gemUpList.appendChild(row);
    }
  }
  function uiInventory(){
    invList.innerHTML = '';
    for(const it of ITEMS){
      const cnt = S.items[it.key]||0;
      const row = document.createElement('div');
      row.className = 'row';
      row.innerHTML = `
        <div class="meta">
          <div><b>${it.name}</b> <span class="small">x${cnt}</span></div>
          <div class="small">${it.desc} ï¼ˆåˆè¨ˆ${Math.round((1+cnt*it.per-1)*100)}%ï¼‰</div>
        </div>
        <div class="tiny">æ’ä¹…</div>`;
      invList.appendChild(row);
    }
  }

  // NEW: ã‚²ãƒ¼ãƒ é€Ÿåº¦UI
  function uiSpeed(){
    speedControls.querySelectorAll('.btn').forEach(btn => {
      btn.classList.remove('primary');
      if (parseFloat(btn.dataset.speed) === S.speedMult) {
        btn.classList.add('primary');
      }
    });
  }

  function uiAll(){ uiTop(); updateHpBar(); uiMercs(); uiCoinUps(); uiGemUps(); uiInventory(); uiSpeed(); } // MODIFIED: uiSpeedã‚’è¿½åŠ 

  // ======= Effects =======
  function popFloat(text){
    const span = document.createElement('div');
    span.className = 'floating';
    span.style.left = (monsterEl.offsetLeft + 110 + (Math.random()*80-40)) + 'px';
    span.style.top = (monsterEl.offsetTop + 80 + (Math.random()*40-20)) + 'px';
    span.textContent = text;
    span.style.opacity = '1';
    document.body.appendChild(span);
    const dy = -40 - Math.random()*20;
    const dur = 600 + Math.random()*300;
    const start = performance.now();
    function anim(t){
      const p = clamp((t-start)/dur,0,1);
      span.style.transform = `translateY(${dy*p}px)`;
      span.style.opacity = String(1-p);
      if(p<1) requestAnimationFrame(anim); else span.remove();
    }
    requestAnimationFrame(anim);
  }
  function flash(msg){
    const n = document.createElement('div');
    n.style.position='fixed';n.style.left='50%';n.style.top='24px';n.style.transform='translateX(-50%)';
    n.style.background='rgba(15,23,42,.9)';n.style.border='1px solid #243042';n.style.padding='10px 14px';n.style.borderRadius='12px';
    n.style.fontWeight='800';n.style.zIndex='9999';
    n.textContent = msg;
    document.body.appendChild(n);
    setTimeout(()=>{n.remove()}, 1600);
  }

  // ======= Controls =======
  function doClickAttack(){ hit(clickDamage()); }
  document.addEventListener('keydown', (e)=>{
    if(e.code==='Space'){ e.preventDefault(); doClickAttack(); }
  });
  const el$ = s=>document.querySelector(s);
  el$('#attackBtn').onclick = doClickAttack;
  monsterEl.onclick = doClickAttack;
  // å¤‰æ›´: nextBtnã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’å‰Šé™¤
  // el$('#nextBtn').onclick = ()=>{ nextFloor(); uiAll(); }; 
  el$('#surrenderBtn').onclick = doSurrender; // NEW: é™å‚ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨­å®š
  el$('#saveBtn').onclick = ()=>{ save(); flash('ã‚»ãƒ¼ãƒ–ã—ã¾ã—ãŸ'); };
  el$('#wipeBtn').onclick = ()=>{
    if(confirm('ã‚»ãƒ¼ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
      localStorage.removeItem('clickHeroLite.save'); location.reload();
    }
  };
  rebirthBtn.onclick = doRebirth;

  // NEW: ã‚²ãƒ¼ãƒ é€Ÿåº¦ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  speedControls.querySelectorAll('.btn').forEach(btn => {
    btn.onclick = () => {
      const newSpeed = parseFloat(btn.dataset.speed);
      if(newSpeed > 0 && newSpeed !== S.speedMult) {
        S.speedMult = newSpeed;
        uiAll(); // UIã‚’æ›´æ–°ã—ã¦ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
        save();
      }
    };
  });


  // ======= Main Loops =======
  let last = performance.now();
  function loop(t){
    // å¤‰æ›´: é€Ÿåº¦å€ç‡ã‚’é©ç”¨
    const dt = ((t-last)/1000) * S.speedMult;
    last = t;
    // DPS tick
    const dps = totalDps();
    if(dps>0){
      const dmg = dps * dt;
      S.monsterHP = clamp(S.monsterHP - dmg, 0, S.monsterMax);
      if(S.monsterHP<=0){ onKill(); }
      updateHpBar();
    }

    // Boss timer tick
    if(S.isBoss){
      S.bossTimeLeft = clamp(S.bossTimeLeft - dt, 0, BOSS_TIMER_SEC);
      updateBossTimer();
      if(S.bossTimeLeft<=0 && S.monsterHP>0){ onBossTimeout(); }
    }

    requestAnimationFrame(loop);
  }

  // autosave
  setInterval(()=>{ save(); }, 10000);

  // ======= Boot =======
  load();
  S.isBoss = floorIsBoss(S.floor);
  S.monsterMax = floorMonsterHP(S.floor);
  S.monsterHP = clamp(S.monsterHP, 1, S.monsterMax);
  if(S.isBoss && (!S.bossTimeLeft || S.bossTimeLeft> BOSS_TIMER_SEC)) S.bossTimeLeft = BOSS_TIMER_SEC;
  spawnMonster();
  uiAll();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
